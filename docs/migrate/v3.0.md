# Docker Compose v3

!!! warning "This doc is WIP and may include wrong information"

Changes made from between the [Docker Compose v2](v2.0.md) version in upstream Pixelfed and this project.

This document assume you are running [Docker Compose v2](v2.0.md) already and is looking to move to v3.

## Breaking Changes

!!! danger "These changes are breaking, removing, or changing existing behavior from Docker Compose v1 and *requires* your attention and possibly some steps to fix."

### <!-- md:flag breaking-change --> Splitting the `Dockerfile` { data-toc-label="Splitting the Dockerfile" }

v3 splits the Dockerfile into two to keep them focused, and reducing build times, by having higher cache utilization.

* One for the "PHP" container ([package](https://github.com/users/jippi/packages/container/package/docker-pixelfed-php), [source](https://github.com/jippi/docker-pixelfed/tree/main/images/php))
    * system packages
    * PHP
    * PECL extensions
    * Composer
* One for the [`runtime`](../customize/runtimes.md) Pixelfed container ([package](https://github.com/jippi/docker-pixelfed/pkgs/container/docker-pixelfed), [source](https://github.com/jippi/docker-pixelfed/tree/main/images/pixelfed))
    * Pixelfed Source Code
    * Apache / nginx / FPM
    * Docker Entrypoint (and it's scripts)

This should not directly impact most users, as any custom build you did before (custom PHP extensions, frontend, etc.) can still be done against the [`runtime`](../customize/runtimes.md) Docker image.

### <!-- md:flag breaking-change --> No `latest` tags { data-toc-label="No 'latest' tags" }

`latest` tags are typically pretty dangerous to use, especially in a fast-moving project such as Pixelfed where things might break in patch releases.

Instead, we now offer the following tags

* `v{major}-{runtime}-{php_version}`
    * for example `v0-apache-8.3` will always point to the *latest* `0.x` release of Pixelfed, using PHP 8.3 and Apache.
    * this tag is **mutable** when any new `0.x.y` release is created from Pixelfed (e.g. `0.15.4`).
    * this tag is **mutable** if a new `docker-pixelfed` release is cut for any `0.x.y` Pixelfed release.
* `v{major}.{minor}-{runtime}-{php_version}`
    * for example `v0.12-apache-8.3` will always point to the *latest* `0.12.x` release of Pixelfed, using PHP 8.3 and Apache.
    * this tag is **mutable** when any new `0.12.x` release is created from Pixelfed (e.g. `0.12.4`).
    * this tag is **mutable** if a new `docker-pixelfed` release is cut for any `0.12.x` Pixelfed release.
* `v{major}.{minor}.{patch}-{runtime}-{php_version}`
    * for example `v0.12.1-apache-8.3`  will always point to the *latest* `0.12.1` release of Pixelfed, using PHP 8.3 and Apache.
    * this tag is **immutable** to any Pixelfed code changes.
    * this tag is **mutable** if a new `docker-pixelfed` release is cut for this Pixelfed release.
* `v{tag}`
    * for example `v0.12.1-docker1-apache-8.3` will always point to exactly the `0.12.1` release of Pixelfed with `docker1` (this projects changes).
    * this tag is **immutable** across Pixelfed and `docker-pixelfed` changes.

## New or improved features

!!! tip "All the new and exciting features and capabilities. :rocket:"

    This is where we hope we can convince you that the breaking changes and migration work was worth it :heart:

### <!-- md:flag improvement-change --> Nightly builds { data-toc-label="Nightly builds" }

We will now automatically create *nightly* builds of Pixelfed from the `dev` and `staging` branches.

* `nightly-dev-{runtime}-{php_version}`
    * Always points to the latest Pixelfed commit on `staging` at the time of building the image (~8am UTC).
* `nightly-staging-{runtime}-{php_version}`
    * Always points to the latest Pixelfed commit on `staging` at the time of building the image (~8am UTC).
* `nightly-{YYYY-MM-DD}-dev-{runtime}-{php_version}`
    * Points to the latest Pixelfed commit on `staging` at the specific date, at the time of building the image (~8am UTC).
    * for example `nightly-20240501-dev-apache-8.3` will always point to the latest commit on `dev` branch at `2024-05-01` (May 1st 2024)
* `nightly-{YYYY-MM-DD}-staging-{runtime}-{php_version}`
    * Points to the latest Pixelfed commit on `staging` at the specific date, at the time of building the image (~8am UTC).
    * for example `nightly-20240501-staging-apache-8.3` will always point to the latest commit on `staging` branch at `2024-05-01` (May 1st 2024)
